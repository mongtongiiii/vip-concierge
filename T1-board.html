<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T1 ORDER STATUS (ì¦‰ì‹œ ì™„ë£Œ)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    

    <style>
        :root {
            --primary-bg: #1a252f;      
            --card-bg: #ffffff;          
            --accent-gold: #c5a059;      
            --text-dark: #333333;
            --text-light: #f4f4f4;
            --alert-red: #e74c3c;
            --goh-color: #d4af37;        
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--primary-bg);
            margin: 0;
            padding: 20px;
            color: var(--text-light);
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 15px;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--accent-gold);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        header h1 i {
            font-size: 1.6rem;
            color: var(--accent-gold);
        }

        header span {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* ì „ì²´ ì£¼ë¬¸ ì™„ë£Œ ë²„íŠ¼ (í˜„í™©íŒ ì™¸ë¶€) ìŠ¤íƒ€ì¼ */
        .batch-complete-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-gold); 
            color: var(--primary-bg); 
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px; 
            box-shadow: 0 4px 10px rgba(197, 160, 89, 0.4);
        }
        .batch-complete-btn:hover {
            background-color: #d4af37; 
        }
        
        /* ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .order-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        /* ì£¼ë¬¸ ì¹´ë“œ ìŠ¤íƒ€ì¼: ê¸°ë³¸ ê¸ˆìƒ‰ í…Œë‘ë¦¬ ìœ ì§€ */
        .order-card {
            background-color: var(--card-bg);
            color: var(--text-dark);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: slideUp 0.5s ease-out;
            border-top: 5px solid var(--accent-gold); /* ê¸ˆìƒ‰ í…Œë‘ë¦¬ */
            display: flex;
            flex-direction: column;
        }
        
        /* 'ì œì¡°ì¤‘' ìƒíƒœì¼ ë•Œ í…Œë‘ë¦¬ ìƒ‰ìƒ ë³€ê²½ ê·œì¹™ ì œê±° (ëª¨ë“  ì¹´ë“œë¥¼ ê¸ˆìƒ‰ìœ¼ë¡œ í†µì¼) */
        /* .order-card[data-status="ì œì¡°ì¤‘"] { border-top: 5px solid #3498db; } */


        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card-header {
            padding: 20px 20px 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .room-name {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary-bg);
        }

        .time-badge {
            background-color: #f0f0f0;
            color: #666;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .card-body {
            padding: 20px;
            flex-grow: 1;
        }

        .menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .menu-list li {
            padding: 10px 0;
            border-bottom: 1px dotted #ddd;
        }
        .menu-list li:last-child {
            border-bottom: none;
        }

        .menu-item {
            font-size: 1.1rem;
            font-weight: 700;
            color: #222;
            display: flex;
            align-items: center;
        }
        
        .goh-tag {
            background-color: var(--goh-color); 
            color: #333333; 
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
            margin-left: 8px;
        }
        
        /* ì” ìˆ˜ëŸ‰ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .quantity-text {
            font-size: 0.9em; 
            margin-left: 10px; 
            font-weight: 500; 
            color: #666;
        }

        .options {
            color: #666;
            font-size: 0.9rem;
            margin-top: 2px;
            display: block;
            font-style: italic;
        }

        .request-box {
            background-color: #fff4e6;
            border-left: 4px solid #ff9800;
            padding: 10px;
            font-size: 0.9rem;
            color: #d35400;
            margin-top: 15px;
            border-radius: 4px;
        }

        .card-footer {
            padding: 15px 20px;
            background-color: #f9f9f9;
            border-top: 1px solid #eee;
        }

        /* 'ì œì¡° ì™„ë£Œ' ë²„íŠ¼ */
        .complete-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-bg);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .complete-btn:hover {
            background-color: #2c3e50;
        }

        /* ì£¼ë¬¸ ì—†ì„ ë•Œ ë©”ì‹œì§€ */
        .no-orders {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px;
            color: var(--text-light);
            font-size: 1.2rem;
            opacity: 0.8;
            font-weight: 500;
        }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-clipboard-list"></i> T1 ORDER STATUS</h1>
        <span id="update-time">ìµœê·¼ ì—…ë°ì´íŠ¸: -</span>
    </header>

    <button class="batch-complete-btn" id="batch-complete-button" style="display: none;" onclick="window.batchCompleteAllOrders()">
        <i class="fas fa-clipboard-check"></i> ì „ì²´ ì£¼ë¬¸ ì™„ë£Œ 
    </button>
    
    <div class="order-container" id="order-dashboard">
        <div class="no-orders" id="no-orders-message">í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <script type="module">
        // Firebase v9 ëª¨ë“ˆ ê°€ì ¸ì˜¤ê¸° (ì•ˆì •ì ì¸ v9.22.1 ì‚¬ìš©)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getDatabase, ref, onValue, update } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js';

        // Firebase Configuration (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
        const firebaseConfig = {
            apiKey: "AIzaSyApkN572GJrTpHt19yrVafEKqf3ZprTE64", 
            authDomain: "iiacprotocol-a9b4f.firebaseapp.com",
            databaseURL: "https://iiacprotocol-a9b4f-default-rtdb.firebaseio.com",
            projectId: "iiacprotocol-a9b4f",
            storageBucket: "iiacprotocol-a9b4f.firebasestorage.app",
            messagingSenderId: "210392744166",
            appId: "1:210392744166:web:2bbf434a6deaf184c4fb27",
            measurementId: "G-C2LMG000J7"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        const CURRENT_TERMINAL = 'terminal1'; // T1 ì£¼ë¬¸ í˜„í™©íŒ
        let pendingOrderKeys = []; 

        // ì „ì—­ í•¨ìˆ˜ ë…¸ì¶œ
        window.completeOrder = completeOrder;
        window.batchCompleteAllOrders = batchCompleteAllOrders;

        // ì£¼ë¬¸ ë°ì´í„°ë¥¼ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ (ë³€ë™ ì—†ìŒ)
        function renderOrderCard(key, data) {
            const roomName = data.room; 
            const timeStr = new Date(data.timestamp).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            let menuListHtml = '<ul class="menu-list">';
            data.orderDetails.forEach(item => {
                const isGOH = item.menu.includes('[ì£¼ë¹ˆ]');
                const cleanMenuName = item.menu.replace('[ì£¼ë¹ˆ] ', '');
                
                const quantityText = item.quantity ? `(${item.quantity}ì”)` : '(1ì”)';

                menuListHtml += `
                    <li>
                        <span class="menu-item">
                            ${cleanMenuName}
                            ${isGOH ? '<span class="goh-tag">ì£¼ë¹ˆ</span>' : ''}
                            <span class="quantity-text"> ${quantityText}</span> 
                        </span>
                        <span class="options">${item.options}</span>
                    </li>
                `;
            });
            menuListHtml += '</ul>';

            const requestHtml = data.request_message.trim() 
                ? `<div class="request-box"><i class="fas fa-comment"></i> **ìš”ì²­ ì‚¬í•­:** ${data.request_message}</div>` 
                : '';

            const cardHtml = `
                <div class="order-card" data-key="${key}" data-timestamp="${data.timestamp}" data-status="${data.status}">
                    <div class="card-header">
                        <div class="room-name">${roomName}</div>
                        <div class="time-badge">${timeStr} | ì´ ${data.totalQuantity}ì”</div>
                    </div>
                    <div class="card-body">
                        ${menuListHtml}
                        ${requestHtml}
                    </div>
                    <div class="card-footer">
                        <button class="complete-btn" onclick="window.completeOrder('${key}', 'ì™„ë£Œ')">
                            <i class="fas fa-check-circle"></i> ì œì¡° ì™„ë£Œ
                        </button>
                    </div>
                </div>
            `;
            return cardHtml;
        }

        // ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ë¥¼ ì •ë ¬í•˜ê³  ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜ (ë³€ë™ ì—†ìŒ)
        function updateDashboard(orders) {
            const dashboard = document.getElementById('order-dashboard');
            const batchButton = document.getElementById('batch-complete-button');
            dashboard.innerHTML = '';
            pendingOrderKeys = []; 

            const validOrders = orders || {}; 
            
            const orderKeys = Object.keys(validOrders).sort((a, b) => {
                return validOrders[a].timestamp - validOrders[b].timestamp; 
            });

            let hasPendingOrders = false;
            orderKeys.forEach(key => {
                // 'ëŒ€ê¸°' ë˜ëŠ” 'ì œì¡°ì¤‘' ìƒíƒœì¸ ì£¼ë¬¸ë§Œ í‘œì‹œ
                if (validOrders[key].status === 'ëŒ€ê¸°' || validOrders[key].status === 'ì œì¡°ì¤‘') { 
                    dashboard.innerHTML += renderOrderCard(key, validOrders[key]);
                    pendingOrderKeys.push(key); 
                    hasPendingOrders = true;
                }
            });

            if (hasPendingOrders) {
                batchButton.style.display = 'flex'; 
            } else {
                dashboard.innerHTML = '<div class="no-orders" id="no-orders-message">í˜„ì¬ ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                batchButton.style.display = 'none';
            }
        }

        // Firebase ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ë³€ë™ ì—†ìŒ)
        const ordersRef = ref(database, `vip_orders/${CURRENT_TERMINAL}`);

        onValue(ordersRef, (snapshot) => {
            const orders = snapshot.val();
            document.getElementById('update-time').textContent = `ìµœê·¼ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR')}`;

            updateDashboard(orders);
        });

        /**
         * ğŸš¨ ê°œë³„ 'ì œì¡° ì™„ë£Œ' ì²˜ë¦¬ í•¨ìˆ˜: ìƒíƒœë¥¼ 'ì™„ë£Œ'ë¡œ ì¦‰ì‹œ ë³€ê²½í•˜ì—¬ í˜„í™©íŒì—ì„œ ì œê±°í•©ë‹ˆë‹¤.
         */
        async function completeOrder(orderKey, type) {
            if (type !== 'ì™„ë£Œ') return;

            const result = await Swal.fire({
                title: 'ê°œë³„ ì£¼ë¬¸ ì™„ë£Œ ì²˜ë¦¬',
                text: 'í•´ë‹¹ ì£¼ë¬¸ì˜ ì œì¡°ê°€ ì™„ë£Œë˜ì—ˆìŒì„ í‘œì‹œí•˜ê³  ìƒíƒœë¥¼ **"ì™„ë£Œ"ë¡œ ë³€ê²½í•˜ì—¬ í˜„í™©íŒì—ì„œ ì œê±°í•©ë‹ˆë‹¤.**',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: 'var(--primary-bg)',
                cancelButtonColor: 'var(--alert-red)',
                confirmButtonText: 'ì¦‰ì‹œ ì™„ë£Œ ì²˜ë¦¬',
                cancelButtonText: 'ì·¨ì†Œ'
            });

            if (result.isConfirmed) {
                try {
                    // ìƒíƒœë¥¼ 'ì™„ë£Œ'ë¡œ ë³€ê²½
                    const orderPath = ref(database, `vip_orders/${CURRENT_TERMINAL}/${orderKey}`);
                    await update(orderPath, {
                        status: 'ì™„ë£Œ',
                        completed_timestamp: Date.now()
                    });
                    Swal.fire('ì™„ë£Œ!', `ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } catch (error) {
                    Swal.fire('ì˜¤ë¥˜!', `ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                }
            }
        }
        
        // í˜„í™©íŒ ì™¸ë¶€ 'ì „ì²´ ì£¼ë¬¸ ì™„ë£Œ' ì²˜ë¦¬ í•¨ìˆ˜ (ë³€ë™ ì—†ìŒ)
        async function batchCompleteAllOrders() {
            if (pendingOrderKeys.length === 0) {
                Swal.fire('ì•Œë¦¼', 'í˜„ì¬ í˜„í™©íŒì— ëŒ€ê¸° ì¤‘ì¸ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            const result = await Swal.fire({
                title: 'í˜„í™©íŒ ì „ì²´ ì£¼ë¬¸ ì™„ë£Œ',
                text: `í˜„ì¬ í˜„í™©íŒì— í‘œì‹œëœ ì´ ${pendingOrderKeys.length}ê±´ì˜ ì£¼ë¬¸ì„ ëª¨ë‘ "ì™„ë£Œ" ì²˜ë¦¬í•˜ê³  ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: 'var(--accent-gold)', 
                cancelButtonColor: '#7f8c8d',
                confirmButtonText: 'ëª¨ë‘ ì™„ë£Œ ì²˜ë¦¬',
                cancelButtonText: 'ì·¨ì†Œ'
            });
            
            if (result.isConfirmed) {
                try {
                    const updates = {};
                    const now = Date.now();
                    
                    pendingOrderKeys.forEach(key => {
                        updates[`vip_orders/${CURRENT_TERMINAL}/${key}/status`] = 'ì™„ë£Œ';
                        updates[`vip_orders/${CURRENT_TERMINAL}/${key}/completed_timestamp`] = now;
                    });
                    
                    await update(ref(database), updates);

                    Swal.fire('ì¼ê´„ ì™„ë£Œ!', `ì´ ${pendingOrderKeys.length}ê±´ì˜ ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                } catch (error) {
                    Swal.fire('ì˜¤ë¥˜!', `ì¼ê´„ ì™„ë£Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                }
            }
        }
    </script>
</body>
</html>